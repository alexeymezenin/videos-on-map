const mapEl=document.getElementById("map"),content=document.getElementById("popup-content"),closer=document.getElementById("popup-closer"),fromFormat="EPSG:3857",toFormat="EPSG:4326",iconStyle=createIconStyle(),map=createMap(),popupOverlay=createPopupOverlay();let currentFeatureLayer;function createIconStyle(){return new ol.style.Style({image:new ol.style.Icon({scale:.5,rotateWithView:!1,anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:1,src:"/assets/marker.png"}),zIndex:5})}function createMap(){return new ol.Map({controls:ol.control.defaults({attribution:!1}).extend([new ol.control.Attribution({collapsible:!1})]),layers:[new ol.layer.Tile({source:new ol.source.OSM})],target:"map",view:new ol.View({center:ol.proj.fromLonLat([parseFloat(mapEl.dataset.lng),parseFloat(mapEl.dataset.lat)]),zoom:parseInt(mapEl.dataset.zoom),minZoom:4,maxZoom:15})})}function createPopupOverlay(){return new ol.Overlay({element:document.getElementById("popup"),autoPan:!0,autoPanAnimation:{duration:250}})}function registerMapEvents(){map.on("moveend",loadMarkers),map.on("singleclick",function(e){if(!0===map.hasFeatureAtPixel(e.pixel)){let t=e.coordinate;map.forEachFeatureAtPixel(e.pixel,function(e,t){content.innerHTML='<iframe width="560" height="315" src="https://www.youtube.com/embed/'+e.get("video")+'" frameborder="0" allow="autoplay;" allowFullScreen allowfullscreen></iframe>'}),popupOverlay.setPosition(t)}else popupOverlay.setPosition(void 0),closer.blur(),content.innerHTML=""})}function loadMarkers(){clearMarkers();let{topLeft:e,bottomRight:t}=getMapBounds();fetch("/api/videos?llat="+t[1]+"&llng="+e[0]+"&rlat="+e[1]+"&rlng="+t[0]).then(e=>e.json()).then(e=>putMarkersOnMap(e)).catch(e=>{})}function getMapBounds(){let e=map.getView().calculateExtent(map.getSize());return{topLeft:ol.proj.transform(ol.extent.getTopLeft(e),fromFormat,toFormat),bottomRight:ol.proj.transform(ol.extent.getBottomRight(e),fromFormat,toFormat)}}function putMarkersOnMap(e){let t,o,a=[];if(e.data){for(t of e.data)a.push(putOneMarkerOnMap(t));o=new ol.layer.Vector({source:new ol.source.Vector({features:a})}),map.addLayer(o)}}function putOneMarkerOnMap(e){let t=new ol.Feature({geometry:new ol.geom.Point(ol.proj.fromLonLat([e.lng,e.lat]))});return t.set("video",e.youtube_id),t.setStyle(iconStyle),t}function clearMarkers(){map.removeLayer(currentFeatureLayer)}map.addOverlay(popupOverlay),registerMapEvents();